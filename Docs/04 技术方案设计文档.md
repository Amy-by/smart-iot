**智能烟感技术方案设计文档**

**一、项目概述**

**1.1 项目背景**

基于管伊佳物联平台现有架构，针对JTY-GD-TCN2010型独立式光电感烟火灾探测报警器（以下简称"传感器"）的Cat.1无线通信特性与双波长低误报检测能力，构建多传感器集中管理系统。该传感器具备电池供电（寿命3年）、免网关部署、防拆/低电/温度/火灾多维度报警功能，可广泛应用于酒店公寓、老旧小区、临街商铺、工业车间、养老机构及文博古建等场景，解决传统烟感设备分散管理、报警响应慢、维护成本高的问题，实现"多对1"的设备统一管控与全流程智能化运维。

**1.2 项目目标**

- 适配JTY-GD-TCN2010传感器的Cat.1
  LPWAN通信协议，实现100+传感器同时在线（可扩展），单设备故障不影响其他设备通信。

<!-- -->

- 覆盖"传感器接入-设备管理-报警处理-通知下发-日志追溯"全流程，支持双波长检测数据解析、多类型报警区分（火灾/温度/低电/防拆）。

<!-- -->

- 满足终端参数远程配置（如上报间隔、报警阈值）、现场声光报警（音量\>80dB）与远程消音控制，确保报警响应延迟≤10s。

<!-- -->

- 实现按**传感器（IMEI）独立**的通知额度管理（语音10条/短信20条免费，超额分别按0.25元/条、0.1元/条计费），支持充值与用量统计，免费额度永久有效，不按月重置。

**二、系统架构**

**2.1 技术架构**

  --------------- --------------------------------- ----------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------------
  层级            技术选型                          核心作用                                                                                                                                              适配依据

  感知层          JTY-GD-TCN2010传感器              采集烟雾浓度（Tag0x14）、温度（Tag0x0B）、电池电量（Tag0x24），触发声光报警                                                                           传感器规格参数、协议Tag定义

  通信层          Cat.1                             传感器通过Cat.1上报帧数据（含包头0x7E、包尾0x7E、CRC校验），平台转换为Mqtt消息                                                                        通信协议、帧结构规范
                  LPWAN（终端主动发起）、Mqtt协议                                                                                                                                                         

  服务端          Spring Boot2.5、MyBatis3.5、Netty 实现Cat.1协议编解码、报警逻辑处理、通知下发；Netty保障高并发连接；集成分布式锁处理额度并发扣减                                                        技术栈选型、协议解析需求、额度并发控制需求

  数据层          MySQL8.0.24、Redis                MySQL 存储设备属性 / 报警日志 / 通知额度（含notification_quota、sensor_contact等新增表）；Redis 缓存设备实时状态（在线 / 离线 /                       数据存储设计、状态数据字段规范、缓存性能需求
                                                    报警）、通信参数（RSRP/SNR）及传感器分类型额度数据（30 分钟缓存）。                                                                                   

  前端层          Vue3.4、Element-plus2.4、Echart   展示传感器列表（按 IMEI /                                                                                                                             用户交互需求、管理功能需求
                                                    区域筛选）、实时数据（烟雾浓度趋势图）、报警弹窗标红；新增通知模板配置（/iot/notification/template）、额度管理（/system/quota）、联系人绑定等页面。   
  --------------- --------------------------------- ----------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------------

**2.2 系统拓扑**

1.  传感器端：JTY-GD-TCN2010通过内置贴片SIM卡（默认移动，电信/联通可定制）接入4G基站，主动上报注册（0x02指令）、参数（0x01指令）、状态（0x01指令）数据。

<!-- -->

2.  平台端：Netty 服务接收 Cat.1 帧数据，解析后存储至 MySQL；Spring Boot
    服务处理报警触发（如烟雾浓度 \> 阈值
    Tag0x14）、通知下发（调用阿里云短信、腾讯云语音等第三方接口），并通过
    Redis 实现**传感器额度并发控制**（按联系人优先级下发通知）。

<!-- -->

3.  用户端：Web端通过接口查看设备详情（含ICCID/模组版本）、配置参数（如正常工作间隔Tag0x06）、管理通知模板与额度；报警时接收弹窗与绑定联系人通知（语音/短信）。

**三、功能模块设计**

**3.1 传感器接入模块（新增）**

**3.1.1 核心功能**

- 协议适配：解析Cat.1帧结构（包头0x7E→协议版本→UTC时间（4字节）→帧号（2字节高位在前）→长度→指令→加密→消息体→CRC→包尾0x7E），提取设备唯一标识IMEI（Tag0x65，BCD\[8\]）。

<!-- -->

- 注册流程：

a.  传感器发送注册消息（指令0x02，明文），消息体含Tag0x65（IMEI）；

<!-- -->

b.  平台返回注册应答（指令0x06，明文），指定后续加密方式（AR/明文）；

<!-- -->

c.  注册成功后，传感器上报参数消息（指令0x01），含模组版本（Tag0x67）、终端类型（Tag0x03，0x98对应JTY-GD-TCN2010-C）、报警阈值（Tag0x14烟雾/Tag0x0B温度）。

- 数据转换：将传感器TLV格式数据（如Tag0x14=0064表示烟雾浓度100%）映射为系统标准属性，转换为Mqtt消息供其他模块调用。

**3.1.2 关键代码实现**

  --------------------------------------------------------------
  Java\
  public class Cat1ProtocolAdapter implements
  SensorProtocolAdapter {\
  \@Override\
  public MqttMessage convertToMqtt(SensorData rawData) {\
  // 1. 校验帧头（0x7E）与帧尾（0x7E）\
  byte\[\] frame = rawData.getFrameBytes();\
  if (frame\[0\] != 0x7E \|\| frame\[frame.length-1\] != 0x7E)
  {\
  throw new ProtocolException(\"帧结构错误：缺少0x7E标识\");\
  }\
  // 2. 解析指令码（第6字节，0x02=注册，0x01=参数/状态）\
  byte cmd = frame\[5\];\
  Map\<Integer, Object\> tlvData = parseTlv(frame, 8,
  frame.length-3); // 消息体起始位置=8，排除CRC与包尾\
  // 3. 提取IMEI（Tag0x65，BCD\[8\]）\
  String imei = parseBcdToString((byte\[\]) tlvData.get(0x65),
  8);\
  // 4. 按指令码封装Mqtt消息\
  if (cmd == 0x02) {\
  return buildRegisterMqttMsg(imei);\
  } else if (cmd == 0x01) {\
  return buildStatusParamMqttMsg(imei, tlvData,
  isParamFrame(tlvData));\
  }\
  return null;\
  }\
  \
  // 判断是否为参数帧（含Tag0x06=正常工作间隔则为参数帧）\
  private boolean isParamFrame(Map\<Integer, Object\> tlvData)
  {\
  return tlvData.containsKey(0x06);\
  }\
  }

  --------------------------------------------------------------

**3.2.1 功能增强**

- 设备状态展示：列表显示传感器核心信息，含：

<!-- -->

- 基础属性：IMEI（Tag0x65）、物料编码（JTY-GD-TCN2010）、安装位置、所属区域、ICCID（Tag0x70）；

<!-- -->

- 实时状态：在线/离线（基于心跳上报，默认12h间隔）、烟雾浓度（Tag0x14）、温度（Tag0x0B）、电池电量（Tag0x24）、信号质量（RSSI
  Tag0x69/RSRP Tag0x6c）；

<!-- -->

- 报警状态：正常/火灾（Tag0x01）/温度（Tag0x02）/低电（Tag0x02）/防拆（Tag0x02），用颜色区分（正常绿、报警红、离线灰）。

<!-- -->

- 批量操作：支持选中传感器批量更新
  "安装位置""绑定联系人""所属区域"，单次最大支持 50
  台设备操作；新增**批量更新传感器联系人接口**，支持同时为多传感器配置多优先级联系人（区分语音
  / 短信通知类型）。

<!-- -->

- 参数配置：可远程修改传感器参数（需下发指令0x07，终端返回0x01确认消息）：

  ------------------ ------------ ------------ ------------ ---------------
  配置项             协议Tag      数据类型     范围         默认值

  正常工作上报间隔   0x06         Int32u       30s-86400s   86400s（24h）

  紧急报警间隔       0x08         Int32u       30s-300s     30s

  烟雾浓度报警阈值   0x14         Int16u       0-200%       100%

  温度报警上限       0x0B         Int8s        -20℃-70℃     50℃

  温度报警下限       0x21         Int8s        -20℃-70℃     -10℃
  ------------------ ------------ ------------ ------------ ---------------

- 批量部署的IMEI自动录入工具：

<!-- -->

- Excel模板强化：必填项校验（deviceNumber/IMEI需15-17位数字，productId需存在于系统产品列表）；扩展字段含activationStatus（默认0-未激活）、installTime（可选），支持导入后批量激活。

<!-- -->

- 导入流程优化：前端解析后展示"导入预览"，标记不合规数据并支持编辑；后端用EasyExcel的readListener流式读取（避免OOM），通过DeviceMapper.checkDuplicateImei批量校验唯一性。

<!-- -->

- 导入日志：新增iot_import_log表，记录导入人、时间、成功数量、失败原因（如"IMEI=860061060282358已存在"），前端可通过/iot/device/importLog查询。

**3.2.2 数据模型扩展**

  --------------------------------------------------------------
  Java\
  public class SensorDevice extends Device {\
  private String materialCode = \"JTY-GD-TCN2010\"; //
  固定物料编码\
  private String installationLocation; // 安装位置\
  private Long areaId; // 所属区域ID\
  private String areaName; // 所属区域名称\
  private List\<Contact\> contacts; //
  绑定联系人列表（含userId/phone/notifyType/priority）\
  // 协议关联属性\
  private String imei; // 设备唯一标识（Tag0x65，BCD\[8\]）\
  private String iccid; // SIM卡ID（Tag0x70，BCD\[10\]）\
  private String moduleVersion; //
  通信模组版本（Tag0x67，ASCII）\
  private String moduleVendor; //
  模组厂商（Tag0x68，如03=利尔达）\
  private Integer terminalType = 0x98; //
  终端类型（Tag0x03，JTY-GD-TCN2010-C专属）\
  private Integer normalWorkInterval = 86400; //
  正常工作间隔（秒，Tag0x06）\
  private Integer emergencyAlarmInterval = 30; //
  紧急报警间隔（秒，Tag0x08）\
  private Integer smokeThreshold = 100; //
  烟雾报警阈值（%，Tag0x14）\
  private Integer tempUpperLimit = 50; //
  温度上限（℃，Tag0x0B）\
  private Integer tempLowerLimit = -10; //
  温度下限（℃，Tag0x21）\
  // Getter/Setter\
  // 联系人内部类（新增）\
  public static class Contact {\
  private Long userId; // 联系人用户ID\
  private String phone; // 联系电话\
  private Integer notifyType; // 通知类型（1=语音，2=短信）\
  private Integer priority; // 通知优先级（1=最高）\
  // Getter/Setter\
  }\
  }

  --------------------------------------------------------------

**3.3 报警处理模块（扩展）**

**3.3.1 报警类型与优先级**

严格遵循传感器报警协议规则，按优先级从高到低排序：

  ---------- --------- --------- ---------------------------------- ----------------------------------
  报警类型   协议Tag   Value值   触发条件                           现场响应

  火灾报警   0x01      0x01      烟雾浓度\>Tag0x14阈值              声光报警（红灯常亮，音量\>80dB）

  防拆报警   0x02      0x03      传感器底座分离                     声光报警（红灯55秒闪1次）

  温度报警   0x02      0x02      温度\>Tag0x0B上限或\<Tag0x21下限   声光报警（红灯55秒闪1次）

  低电报警   0x02      0x02      电池电量\<20%（Tag0x24）           声光报警（红灯55秒闪1次）
  ---------- --------- --------- ---------------------------------- ----------------------------------

  ----------------------------------------------------------------------------------------------------------
  注：多报警同时触发时，仅上报优先级最高的类型（如火灾+防拆报警，仅上报火灾报警）。**报警类型编码说明**：1 =
  火灾，2 = 温度，3 = 低电，4 = 防拆（新增）。

  ----------------------------------------------------------------------------------------------------------

**3.3.2 核心功能实现**

- 报警检测：接收传感器状态消息（指令0x01），解析TLV中的报警Tag（0x01/0x02），比对阈值后触发报警。

<!-- -->

- 远程控制：支持下发控制指令（0x04），实现：

a.  蜂鸣器消音（Tag0x20，设置消音时间30s-86400s，默认120s）；

<!-- -->

b.  设备重启（Tag0x0C，Value=0x01有效）；

<!-- -->

c.  恢复出厂设置（Tag0x0D，Value=0x01有效）。

- 前端交互：报警触发后，Web端通过WebSocket推送弹窗，标红对应传感器，显示"IMEI+安装位置+报警类型+触发值"（如"IMEI:869149040980562
  位置:1号仓库 火灾报警 烟雾浓度:120%"）。

<!-- -->

- 电池更换提醒阈值配置：

<!-- -->

- 阈值管理强化：在ThingsModel中为battery_level添加threshold_config字段（JSON格式），支持按设备类型配置不同阈值（如{\"default\":25,\"device_type_1\":30}）；前端支持按区域/产品批量设置，记录存入iot_threshold_log。

<!-- -->

- 提醒触发优化：连续3次上报电量低于阈值才触发提醒（基于SceneContext存储最近3次数据）；触发后设备状态更新为"待维护"（maintain_status=1），维护完成后手动置为正常，记录到iot_maintain_log。

**3.3.3 关键代码实现**

  --------------------------------------------------------------
  Java\
  \@Service\
  public class SensorAlarmService {\
  \@Autowired\
  private NotificationService notificationService;\
  \@Autowired\
  private WebSocketService webSocketService;\
  \
  public void handleAlarm(SensorData data) {\
  String sensorId = data.getSensorId(); // IMEI\
  Map\<Integer, Object\> tlvData = data.getTlvData();\
  // 1. 按优先级解析报警类型（优先Tag0x01，再Tag0x02）\
  AlarmType alarmType = parseAlarmType(tlvData);\
  if (alarmType == null) return;\
  \
  // 2. 记录报警日志（含触发Tag与值）\
  AlarmLog log = new AlarmLog();\
  log.setSensorId(sensorId);\
  log.setAlarmType(alarmType);\
  log.setTriggerTag(alarmType == AlarmType.FIRE ? 0x01 : 0x02);\
  log.setTriggerValue(getTriggerValue(tlvData, alarmType)); //
  如烟雾浓度120%\
  log.setAlarmTime(new Date());\
  alarmLogMapper.insert(log);\
  \
  // 3. 前端弹窗通知\
  String alarmMsg = String.format(\"IMEI:%s 位置:%s 报警类型:%s
  触发值:%s\",\
  sensorId, data.getInstallationLocation(), alarmType.getName(),
  log.getTriggerValue());\
  webSocketService.pushAlarmMsg(alarmMsg);\
  \
  // 4. 调用通知模块，下发语音/短信\
  notificationService.triggerNotification(sensorId, alarmType);\
  }\
  \
  // 解析报警类型（优先级：火灾\>防拆\>温度\>低电）\
  private AlarmType parseAlarmType(Map\<Integer, Object\>
  tlvData) {\
  // 先判断火灾报警（Tag0x01）\
  if (tlvData.containsKey(0x01) && (byte) tlvData.get(0x01) ==
  0x01) {\
  return new AlarmType(1, \"火灾报警\"); // 新增编码\
  }\
  // 再判断Tag0x02的其他报警（略）\
  if (tlvData.containsKey(0x02)) {\
  byte value = (byte) tlvData.get(0x02);\
  if (value == 0x03) {\
  return new AlarmType(4, \"防拆报警\"); // 新增编码\
  } else if (value == 0x02) {\
  int temp = (byte) tlvData.get(0x0B);\
  int battery = (byte) tlvData.get(0x24);\
  SensorDevice device =
  (SensorDevice)DeviceUtil.getDevice(sensorId);\
  if (temp \> device.getTempUpperLimit() \|\| temp \<
  device.getTempLowerLimit()) {\
  return new AlarmType(2, \"温度报警\"); // 新增编码\
  } else if (battery \< 20) {\
  return new AlarmType(3, \"低电报警\"); // 新增编码\
  }\
  }\
  }\
  return null;\
  }\
  \
  // 报警类型枚举（新增）\
  public static class AlarmType {\
  private Integer code; // 编码（1-4）\
  private String name; // 名称\
  public AlarmType(Integer code, String name) {\
  this.code = code;\
  this.name = name;\
  }\
  // Getter\
  }

  --------------------------------------------------------------

**3.4 通知管理模块（新增）**

**3.4.1 第三方接口对接**

- 短信：阿里云短信服务（API版本2017-05-25），核心接口SendSms（单条）、SendBatchSms（批量），通过TemplateCode区分报警类型；前端新增"通知模板配置"页面（/iot/notification/template），支持录入备案后的SignName和TemplateCode，存储于sys_notification_template表（关联产品ID复用）。

<!-- -->

- 语音：腾讯云语音通知（TTS模板），核心接口SendTtsVoice，通过TemplateId定义内容（如"您负责的区域传感器电量不足，请及时处理"），支持语速、音量配置。

**3.4.2 额度管理**

- 额度模型设计：新增**notification_quota 表**（删除原
  sys_notification_quota 表），字段包括 id（主键）、sensor_id（VARCHAR
  (32)，传感器
  IMEI，主键）、free_voice_count（INT，剩余免费语音条数，初始
  10）、free_sms_count（INT，剩余免费短信条数，初始
  20）、balance（DECIMAL (10,2)，账户余额，初始
  0）；新增**sensor_contact 表**，字段包括
  id（主键）、sensor_id（VARCHAR
  (32)）、user_id（BIGINT）、phone（VARCHAR
  (20)）、notify_type（TINYINT，1 = 语音 / 2 =
  短信）、priority（TINYINT，1 = 最高）（新增）。

<!-- -->

- 额度校验与扣减逻辑：在NotificationService中新增校验步骤，用Redis保证并发安全（缓存30分钟）；通过Redis的SETNX实现分布式锁，结合Lua脚本原子扣减（避免超扣）。

  ---------------------------------------------------------------
  Java\
  \
  // 发送前校验额度（调整为传感器维度+分类型）\
  private void checkAndDeductQuota(String sensorId, Integer
  notifyType) {\
  // 1. 查询传感器额度（Redis→MySQL）\
  String quotaKey = \"notification:quota:\" + sensorId;\
  NotificationQuota quota = (NotificationQuota)
  redisCache.getCacheObject(quotaKey);\
  if (quota == null) {\
  quota = notificationQuotaMapper.selectBySensorId(sensorId);\
  if (quota == null) {\
  // 初始化额度（语音10条、短信20条、余额0）\
  quota = new NotificationQuota(sensorId, 10, 20,
  BigDecimal.ZERO);\
  notificationQuotaMapper.insert(quota);\
  }\
  redisCache.setCacheObject(quotaKey, quota, 30,
  TimeUnit.MINUTES);\
  }\
  // 2.
  按通知类型校验额度（语音→freeVoiceCount，短信→freeSmsCount）\
  boolean isVoice = notifyType == 1;\
  if (isVoice && quota.getFreeVoiceCount() \> 0) {\
  // 扣减免费语音额度\
  quota.setFreeVoiceCount(quota.getFreeVoiceCount() - 1);\
  } else if (!isVoice && quota.getFreeSmsCount() \> 0) {\
  // 扣减免费短信额度\
  quota.setFreeSmsCount(quota.getFreeSmsCount() - 1);\
  } else {\
  // 免费额度不足，扣减余额\
  BigDecimal price = isVoice ? NotificationQuota.VOICE_PRICE :
  NotificationQuota.SMS_PRICE;\
  if (quota.getBalance().compareTo(price) \< 0) {\
  throw new ServiceException(\"传感器\" + sensorId +
  \"通知额度/余额不足，请充值\");\
  }\
  quota.setBalance(quota.getBalance().subtract(price));\
  }\
  // 3. 更新数据库+缓存\
  notificationQuotaMapper.updateById(quota);\
  redisCache.setCacheObject(quotaKey, quota, 30,
  TimeUnit.MINUTES);\
  }\
  \
  // 通知额度实体（调整）\
  public class NotificationQuota {\
  public static final BigDecimal VOICE_PRICE = new
  BigDecimal(\"0.25\"); // 语音单价\
  public static final BigDecimal SMS_PRICE = new
  BigDecimal(\"0.1\"); // 短信单价\
  \
  private Long id;\
  private String sensorId; // 关联传感器IMEI\
  private Integer freeVoiceCount; // 剩余免费语音\
  private Integer freeSmsCount; // 剩余免费短信\
  private BigDecimal balance; // 账户余额\
  \
  // 构造器\
  public NotificationQuota(String sensorId, Integer
  freeVoiceCount, Integer freeSmsCount, BigDecimal balance) {\
  this.sensorId = sensorId;\
  this.freeVoiceCount = freeVoiceCount;\
  this.freeSmsCount = freeSmsCount;\
  this.balance = balance;\
  }\
  // Getter/Setter\
  }\
  // 2. 校验额度是否充足\
  if (quota.getUsedQuota() \>= quota.getTotalQuota()) {\
  throw new
  ServiceException(\"通知额度已耗尽，请联系管理员扩容\");\
  }\
  \
  // 3. 原子扣减额度（更新数据库+缓存）\
  quota.setUsedQuota(quota.getUsedQuota() + 1);\
  quota.setLastUsedTime(new Date());\
  notificationQuotaMapper.updateById(quota);\
  redisCache.setCacheObject(quotaKey, quota, 30,
  TimeUnit.MINUTES);\
  }

  ---------------------------------------------------------------

- 并发控制Lua脚本：

  --------------------------------------------------------------
  Lua\
  \-- 检查并扣减传感器分类型额度的Lua脚本（确保原子性）\
  local key = KEYS\[1\]\
  local notifyType = tonumber(ARGV\[1\]) \-- 1=语音，2=短信\
  local freeVoice = tonumber(ARGV\[2\])\
  local freeSms = tonumber(ARGV\[3\])\
  local balance = tonumber(ARGV\[4\])\
  local voicePrice = tonumber(ARGV\[5\])\
  local smsPrice = tonumber(ARGV\[6\])\
  \
  if notifyType == 1 then\
  if freeVoice \> 0 then\
  redis.call(\'hincrby\', key, \'free_voice_count\', -1)\
  return 1 \-- 扣减免费语音成功\
  else\
  if balance \>= voicePrice then\
  redis.call(\'hincrbyfloat\', key, \'balance\', -voicePrice)\
  return 1 \-- 扣减余额成功\
  end\
  end\
  else\
  if freeSms \> 0 then\
  redis.call(\'hincrby\', key, \'free_sms_count\', -1)\
  return 1 \-- 扣减免费短信成功\
  else\
  if balance \>= smsPrice then\
  redis.call(\'hincrbyfloat\', key, \'balance\', -smsPrice)\
  return 1 \-- 扣减余额成功\
  end\
  end\
  end\
  return 0 \-- 额度不足

  --------------------------------------------------------------

- 额度预警与扩容：配置中心新增notification.alert_ratio=0.8（使用达80%预警），通过定时任务NotificationQuotaAlertJob每日检查并通知管理员；前端新增"额度管理"页面（/system/quota），管理员可手动调整total_quota，记录存入sys_operation_log。

**3.4.3 通知触发流程**

1.  接收报警事件，获取传感器 IMEI 与报警类型；

<!-- -->

2.  查询该传感器绑定的联系人列表（按**priority
    降序排序**，高优先级联系人优先通知）；

<!-- -->

3.  按联系人 notifyType（语音 / 短信）分别校验额度：

- 免费额度充足：扣减对应类型免费条数，调用第三方接口发送通知；・

<!-- -->

- 免费额度不足：计算对应类型费用（语音 0.25 元 / 短信 0.1
  元），余额充足则扣减余额并发送，余额不足则跳过该联系人并记录日志；

4.  通知内容模板：

- 语音："您好，编号{IMEI}的烟感传感器触发{报警类型}，位置{安装位置}，当前{触发值}，请及时处理。"

<!-- -->

- 短信："【智能烟感系统】报警通知：IMEI:{IMEI}，类型:{报警类型}，位置:{安装位置}，触发值:{触发值}，时间:{报警时间}。"

**3.5 数据日志模块（扩展）**

**3.5.1 日志分类与字段**

按传感器维度存储核心日志，包含通信与统计相关字段：

  ---------------------- ---------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------------------
  日志类型               核心字段                                                                                                                                                         说明

  报警日志               sensor_id (IMEI)、alarm_type（1 = 火灾，2 = 温度，3 = 低电，4 = 防拆）、trigger_tag、trigger_value、alarm_time、handle_status（补充 alarm_type 编码说明）        记录报警触发信息与处理状态

  通知日志               sensor_id (IMEI)、notify_type (1 = 语音 / 2 = 短信)、receiver (电话)、send_result、**quota_type(VOICE/SMS)**、**free_used (0 = 免费 / 1 = 付费)**、quota_used    记录通知发送详情与额度消耗
                         (免费 / 付费)、send_time（新增 2 个字段）                                                                                                                        

  状态变更日志           sensor_id(IMEI)、status(在线/离线)、smoke_concentration(Tag0x14)、temperature(Tag0x0B)、battery(Tag0x24)、rsrp(Tag0x6c)、send_fail_count(Tag0x17)、update_time   记录设备状态与关键参数变化

  配置日志               sensor_id(IMEI)、config_tag(如0x06/0x14)、old_value、new_value、config_time、confirm_status(成功/待确认)                                                         记录参数配置操作与终端确认结果

  导入日志（新增）       id、import_user、import_time、success_count、fail_count、fail_reason、file_name                                                                                  记录传感器批量导入详情（存储于iot_import_log）

  阈值调整日志（新增）   id、sensor_id、threshold_type、old_value、new_value、operate_user、operate_time                                                                                  记录电池阈值等调整操作（存储于iot_threshold_log）
  ---------------------- ---------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------------------

**3.5.2 查询与导出**

- 支持多条件筛选：按传感器IMEI、时间范围（精确到分钟）、日志类型、报警类型、发送结果等；

<!-- -->

- 支持Excel导出：单次最多导出1000条日志，包含所有核心字段，便于离线分析。

**3.6 系统权限管理（细化）**

**3.6.1 权限模型扩展**

- 角色类型：sys_role表新增role_type字段（0-超级管理员，1-区域管理员，2-普通用户），区域管理员关联sys_role_area表（存储可管理的area_id列表）。

<!-- -->

- 接口过滤：基于Spring
  Security的MethodSecurityInterceptor，在设备查询接口（如DeviceController.list）添加数据权限注解：

  --------------------------------------------------------------
  Java\
  \@PreAuthorize(\"@ss.hasAreaPermission(#query.areaId)\")\
  public TableDataInfo list(DeviceQuery query) {\
  // 业务逻辑\
  }

  --------------------------------------------------------------

其中hasAreaPermission方法实现：

  --------------------------------------------------------------
  Java\
  public boolean hasAreaPermission(Long areaId) {\
  LoginUser user = SecurityUtils.getLoginUser();\
  if (user.getRoleType() == 0) { // 超级管理员\
  return true;\
  }\
  // 区域管理员仅能查看关联的areaId\
  return user.getManageAreaIds().contains(areaId);\
  }

  --------------------------------------------------------------

**3.6.2 前端数据隔离**

- 设备列表页面通过v-if=\"user.roleType !==
  1\"隐藏非所属区域设备，下拉筛选框（如区域选择器）仅加载用户有权限的区域选项（调用/system/area/listByUser接口）。

**四、接口设计**

**4.1 传感器数据上报接口**

  --------------------------------------------------------------
  Plain Text\
  POST /api/sensor/cat1/report\
  Content-Type: application/json\
  Request: {\
  \"frameData\":
  \"7E0164A7B320000100150200650808691490409805627E\"\
  // 帧结构解析：\
  // 7E(包头) 01(协议版本) 64A7B320(UTC时间) 0001(帧号)
  0015(消息体长度) 02(指令=注册) 00(加密=明文)\
  // 65080869149040980562(消息体：Tag0x65=IMEI) 7E(包尾)\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"上报成功\",\
  \"frameNo\": \"0002\", // 平台应答帧号\
  \"registerStatus\": \"pending\" // 注册中（待下发0x06应答）\
  }

  --------------------------------------------------------------

**4.2 参数配置接口**

**4.2.1传感器参数配置接口**

  ------------------------------------------------------------------------------------
  Plain Text\
  POST /api/sensor/config\
  Content-Type: application/json\
  Request: {\
  \"sensorId\": \"869149040980562\", // IMEI\
  \"configParams\": {\
  \"smokeThreshold\": 110, // Tag0x14（烟雾阈值）\
  \"tempUpperLimit\": 55, // Tag0x0B（温度上限）\
  \"normalWorkInterval\": 43200 // Tag0x06（正常上报间隔12h）\
  }\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"配置下发成功\",\
  \"confirmStatus\": \"pending\", // 待终端返回0x01确认消息\
  \"frameData\":
  \"7E0164A7B321000300180700650808691490409805621402006E0B0137060300B2007E\"\
  //
  配置指令帧：指令0x07，Tag0x14=006E(110%)、Tag0x0B=37(55℃)、Tag0x06=00B200(43200s)\
  }

  ------------------------------------------------------------------------------------

**4.2.2批量更新传感器联系人（新增）**

  --------------------------------------------------------------
  Java\
  \
  POST /api/device/sensor/batch/update-contacts\
  Content-Type: application/json\
  Request: {\
  \"sensorIds\": \[\"869149040980562\", \"869149040980563\"\],
  // 传感器IMEI列表\
  \"contacts\": \[\
  {\
  \"userId\": 1,\
  \"phone\": \"13800138000\",\
  \"notifyType\": 1, // 1=语音\
  \"priority\": 1 // 1=最高优先级\
  },\
  {\
  \"userId\": 2,\
  \"phone\": \"13900139000\",\
  \"notifyType\": 2, // 2=短信\
  \"priority\": 2\
  }\
  \]\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"更新成功\",\
  \"data\": {\
  \"successCount\": 2,\
  \"failCount\": 0,\
  \"failReason\": \"\"\
  }\
  }

  --------------------------------------------------------------

**4.3 通知额度查询接口**

  --------------------------------------------------------------
  JSON\
  GET /api/notification/quota?sensorId=869149040980562\
  Response: {\
  \"code\": 200,\
  \"data\": {\
  \"sensorId\": \"869149040980562\",\
  \"freeVoiceCount\": 5, // 剩余免费语音条数\
  \"freeSmsCount\": 10, // 剩余免费短信条数\
  \"balance\": 100.00, // 账户余额（元）\
  \"voicePrice\": 0.25, // 语音单价（元/条）\
  \"smsPrice\": 0.1 // 短信单价（元/条）\
  }\
  }

  --------------------------------------------------------------

**4.4 额度调整接口（新增）**

  --------------------------------------------------------------
  JSON\
  POST /api/notification/updateQuota\
  Content-Type: application/json\
  Request: {\
  \"sensorId\": \"869149040980562\", // 传感器IMEI（必传）\
  \"freeVoiceCount\": 20, // 可选：调整后免费语音条数\
  \"freeSmsCount\": 30, // 可选：调整后免费短信条数\
  \"balance\": 200.00 // 可选：调整后账户余额\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"额度调整成功\",\
  \"data\": {\
  \"sensorId\": \"869149040980562\",\
  \"freeVoiceCount\": 20,\
  \"freeSmsCount\": 30,\
  \"balance\": 200.00\
  }\
  }

  --------------------------------------------------------------

**4.5 传感器批量导入接口（新增）**

  --------------------------------------------------------------
  Plain Text\
  POST /api/iot/device/batchImport\
  Content-Type: multipart/form-data\
  Request: {\
  \"file\": \[二进制Excel文件\],\
  \"productId\": 1001 // 关联产品ID\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"导入完成\",\
  \"data\": {\
  \"successCount\": 80,\
  \"failCount\": 20,\
  \"failReason\": \"IMEI=860061060282358已存在;
  productId=999不存在\"\
  }\
  }

  --------------------------------------------------------------

**五、数据存储设计**

**5.1 新增数据表**

**1. sensor_extend（传感器扩展信息表）**

  -------------------------- --------------- --------------- ----------------------------------
  字段名                     类型            长度            说明

  sensor_id                  VARCHAR         32              主键（IMEI号，Tag0x65）

  material_code              VARCHAR         64              物料编码（固定JTY-GD-TCN2010）

  installation_location      VARCHAR         255             安装位置

  area_id                    BIGINT          \-              所属区域ID

  area_name                  VARCHAR         64              所属区域名称

  iccid                      VARCHAR         32              SIM卡ID（Tag0x70，BCD\[10\]）

  module_version             VARCHAR         64              通信模组版本（Tag0x67）

  module_vendor              VARCHAR         32              模组厂商（Tag0x68，如利尔达=03）

  terminal_type              TINYINT         \-              终端类型（固定0x98，Tag0x03）

  normal_work_interval       INT             \-              正常上报间隔（秒，Tag0x06）

  emergency_alarm_interval   INT             \-              紧急报警间隔（秒，Tag0x08）

  smoke_threshold            INT             \-              烟雾阈值（%，Tag0x14）

  temp_upper_limit           TINYINT         \-              温度上限（℃，Tag0x0B）

  temp_lower_limit           TINYINT         \-              温度下限（℃，Tag0x21）

  battery_life               VARCHAR         16              电池寿命（固定3年）

  protection_level           VARCHAR         8               防护等级（固定IP30）
  -------------------------- --------------- --------------- ----------------------------------

**2. sensor_alarm_log（传感器报警日志表）**

  --------------- --------------- --------------- --------------------------------
  字段名          类型            长度            说明

  id              BIGINT          \-              主键

  sensor_id       VARCHAR         32              传感器IMEI

  alarm_type      TINYINT         \-              报警类型（1 = 火灾，2 = 温度，3
                                                  = 低电，4 = 防拆）

  trigger_tag     TINYINT         \-              触发报警的协议Tag（0x01/0x02）

  trigger_value   VARCHAR         32              触发值（如"烟雾浓度:120%"）

  alarm_time      DATETIME        \-              报警时间

  handle_status   TINYINT         \-              处理状态（0=未处理，1=已处理）

  handle_time     DATETIME        \-              处理时间（如消音时间）

  handle_user     VARCHAR         32              处理人（用户名）
  --------------- --------------- --------------- --------------------------------

**3. notification_quota（通知额度表，新增）**

![](media/image1.jpeg)

**点击图片可查看完整电子表格**

4\. **sensor_contact（传感器联系人表，新增）**

![](media/image2.jpeg)

**点击图片可查看完整电子表格**

**5. sys_notification_template（通知模板表，新增）**

  -------------------- -------------------- ----------------------------
  字段名               类型                 说明

  id                   bigint               主键

  product_id           bigint               关联产品ID（实现模板复用）

  sign_name            varchar              短信签名（阿里云）

  template_code        varchar              短信模板CODE（阿里云）

  template_id          varchar              语音模板ID（腾讯云）

  create_time          datetime             创建时间
  -------------------- -------------------- ----------------------------

**6. iot_import_log（导入日志表，新增）**

  -------------------- -------------------- --------------------------------
  字段名               类型                 说明

  id                   bigint               主键

  import_user          varchar              导入人

  import_time          datetime             导入时间

  success_count        int                  成功数量

  fail_count           int                  失败数量

  fail_reason          text                 失败原因（如"IMEI=xxx已存在"）

  file_name            varchar              导入文件名
  -------------------- -------------------- --------------------------------

**7. sys_role_area（角色区域关联表，新增）**

  -------------------- -------------------- --------------------
  字段名               类型                 说明

  id                   bigint               主键

  role_id              bigint               角色ID

  area_id              bigint               区域ID
  -------------------- -------------------- --------------------

**8. iot_threshold_log（阈值调整日志表，新增）**

  -------------------- -------------------- -------------------------
  字段名               类型                 说明

  id                   bigint               主键

  sensor_id            varchar              传感器IMEI

  threshold_type       varchar              阈值类型（如"battery"）

  old_value            varchar              旧值

  new_value            varchar              新值

  operate_user         varchar              操作人

  operate_time         datetime             操作时间
  -------------------- -------------------- -------------------------

**5.2 索引设计（优化查询性能）**

- sensor_extend：主键索引（sensor_id）、普通索引（area_id，支持按区域筛选）、联合索引（sensor_id+terminal_type，快速定位设备类型）；

<!-- -->

- sensor_alarm_log：普通索引（sensor_id）、联合索引（alarm_time+alarm_type，支持按时间+报警类型筛选）；

<!-- -->

- **notification_quota**：主键索引（sensor_id）、普通索引（free_voice_count，快速定位语音额度不足）、普通索引（free_sms_count，快速定位短信额度不足）；

<!-- -->

- **sensor_contact**：普通索引（sensor_id）、联合索引（sensor_id+priority，快速查询高优先级联系人）；

<!-- -->

- iot_import_log：普通索引（import_time）、普通索引（import_user）；

<!-- -->

- sys_role_area：联合索引（role_id+area_id）。

**六、稳定性与扩展性保障**

**6.1 稳定性保障**

1.  通信可靠性：

- 帧校验：基于CRC校验（帧号到消息体），丢弃校验失败的帧；

<!-- -->

- 重传机制：传感器未收到平台应答时，按30s间隔重传，最多重传3次；

<!-- -->

- 心跳检测：传感器按正常工作间隔（Tag0x06）上报心跳，超时3倍间隔未上报则标记为离线。

2.  数据一致性：

- 参数配置：下发指令（0x07）后，需终端返回0x01确认消息才算配置成功，否则重试2次；

<!-- -->

- 额度扣减：采用MySQL事务+Redis分布式锁，结合Lua脚本确保"通知发送+额度扣减"原子性，避免重复扣费或漏扣费。

3.  性能监控：

- 通信质量监控：统计RSRP（Tag0x6c）、SNR（Tag0x6d）、发送失败帧计数（Tag0x17），低于阈值（如RSRP\<-120dBm）时触发维护通知；

<!-- -->

- 系统负载监控：集成Prometheus，监控Netty连接数（支持100+并发）、消息吞吐量（峰值100条/秒）、Redis缓存命中率，负载超80%时自动扩容。

**6.2 扩展性设计**

1.  传感器类型扩展：通过物模型动态适配新传感器，只需在iot_things_model表中新增Tag配置（如新增温湿度传感器，添加湿度Tag0x25），无需修改协议解析核心逻辑；

<!-- -->

2.  设备容量扩展：

- 数据库分表：历史日志按"sensor_id哈希+时间范围"分表（如每月1张表），减轻单表压力；

<!-- -->

- Redis集群：采用主从架构，缓存1000+传感器实时状态与额度数据，支持水平扩展；

3.  功能扩展：预留"第三方平台对接接口"（如消防控制中心API），可通过配置将报警信息同步至外部系统，满足定制化需求；

<!-- -->

4.  兼容性保障：权限框架复用Constants.SUPER_ADMIN和store/modules/permission.js动态路由；缓存策略复用RedisConfig，新增缓存键前缀（如NOTIFICATION_QUOTA_KEY
    = \"notification:quota:\"）；遵循AGPLv3协议，git记录修改历史。
