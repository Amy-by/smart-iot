**模块化拓展架构设计文档**

**一、架构概述**

**1.1 设计目标**

基于现有管伊佳物联平台架构，拓展支持多传感器（JTY-GD-TCN2010型独立式光电感烟报警器）接入与管理，实现\"多对1\"的设备集中管控能力，满足设备管理、报警处理、通知管理和数据日志的全流程模块化设计，确保系统稳定性与可扩展性。

**1.2 现有架构适配**

依托现有技术栈进行拓展：

后端：基于Spring Boot2.5、MyBatis3.5、Spring
Security，复用Netty实现传感器Cat1无线通信接入

前端：基于Vue3.4、Element-plus2.4，扩展设备列表与报警交互组件

数据存储：MySQL8.0.24存储设备与业务数据，Redis缓存实时状态与通知额度

通信层：基于Cat1
LPWAN模式（终端主动发起交互）实现传感器数据传输，确保单设备故障隔离

**二、核心模块设计**

**2.1 传感器接入模块（新增）**

**2.1.1 功能定位**

实现JTY-GD-TCN2010型传感器Cat1无线接入适配，标准化帧结构解析与应用协议交互逻辑。

**2.1.2 通信协议规范**

**通信方式**：Cat1 LPWAN模式，终端作为主动发起端与服务器进行数据交互

**数据类型**：支持BIT、BYTE、WORD、DWORD、BYTE\[n\]、BCD\[n\]、Int32u、Int8s、Int16u等

**帧结构定义**（总长度可变）：

  -------------- -------------- -------------------------------- -----------------------------------
  字段           占用字节       描述                             固定值/规则

  包头           1 BYTE         数据开始标识                     0x7E

  协议版本       1 BYTE         标识消息体协议版本               按设备上报值解析

  时间           4 BYTE         帧发送时间（UTC）                终端上报的时间戳

  帧号           2 BYTE         发送包计数（高位在前）           按设备上报值累计

  长度           2 BYTE         消息体长度                       后续消息体字节数

  指令           1 BYTE         帧属性标识                       0x02（注册）、0x01（状态/参数）等

  加密           1 BYTE         消息体加密标识                   0（无需加密）、AR（按注册结果）

  消息体         N BYTE         核心数据（TLV格式）              含设备标识、状态、参数等信息

  CRC校验位      2 BYTE         帧号到消息体的校验（高位在前）   按设备上报值校验

  包尾           1 BYTE         数据结束标识                     0x7E
  -------------- -------------- -------------------------------- -----------------------------------

**2.1.3 核心设计**

**协议适配层**：基于Netty框架实现Cat1协议编解码，核心接口如下：

  -----------------------------------------------------------
  Java\
  // Cat1协议适配实现类\
  public class Cat1ProtocolAdapter implements
  SensorProtocolAdapter {\
  // 解析Cat1帧结构，转换为系统标准MQTT消息\
  \@Override\
  public MqttMessage convertToMqtt(SensorData rawData) {\
  // 1. 校验帧头帧尾（0x7E）\
  // 2. 解析指令码区分消息类型（注册/状态/参数）\
  // 3. 按TLV格式解析消息体（Tag-Length-Value）\
  // 4. 映射为系统标准数据格式\
  }\
  \
  // 从消息体中提取设备唯一标识（IMEI，Tag0x65）\
  \@Override\
  public String getSensorId(SensorData rawData) {\
  // 解析TLV中Tag0x65对应的BCD码IMEI号\
  }\
  }

  -----------------------------------------------------------

**设备注册机制**：按协议规定的注册流程实现

终端发送注册消息（指令码0x02，明文），消息体含Tag0x65（IMEI号，BCD码8字节）

平台返回注册应答（指令码0x06，明文），指定后续通信加密方式

注册成功后，终端上报参数消息（指令码0x01），含设备基础参数

**物模型属性映射**：基于协议Tag编码定义传感器属性

  ------------------ ----------- ----------- ----------- ------------------------------------
  系统属性           协议Tag     数据类型    单位        说明

  IMEI号             0x65        BCD\[8\]    \-          设备唯一标识

  烟雾浓度           0x14        Int16u      \%          状态帧中为当前浓度，参数帧中为阈值

  温度值             0x0B        Int8s       ℃           状态帧中为当前温度，参数帧中为上限

  温度下限           0x21        Int8s       ℃           温度报警下限

  电池电量           0x24        BYTE        \%          无符号8位整型表示电量百分比

  信号质量（RSSI）   0x69        Int8s       \-          有符号数表示信号强度

  RSRP               0x6c        Int16u      \-          参考信号接收功率

  ICCID              0x70        BCD\[10\]   \-          SIM卡ID
  ------------------ ----------- ----------- ----------- ------------------------------------

**2.2 设备管理模块（扩展）**

**2.2.1 功能增强**

在现有设备管理基础上扩展：

支持传感器按编号（IMEI）/区域分类展示，显示核心状态（正常/报警/离线）

批量录入/编辑传感器属性（安装位置、联系人、所属区域）

支持查询传感器详细参数（通信模组版本、工作间隔、报警阈值等）

单独查看某一传感器的历史数据（烟雾浓度、温度、电池状态）

**2.2.2 数据模型扩展**

  --------------------------------------------------------------
  Java\
  // 传感器扩展实体\
  public class SensorDevice extends Device {\
  private String materialCode; // 物料编码（JTY-GD-TCN2010）\
  private String installationLocation; // 安装位置\
  private Long areaId; // 所属区域ID\
  private String areaName; // 所属区域名称\
  private List\<Contact\> contacts; // 绑定联系人列表\
  // 协议关联属性\
  private String imei; // 设备唯一标识（Tag0x65）\
  private String iccid; // SIM卡ID（Tag0x70）\
  private String moduleVersion; // 通信模组软件版本（Tag0x67）\
  private Integer normalWorkInterval; //
  正常工作上报间隔（秒，Tag0x06）\
  private Integer emergencyAlarmInterval; //
  紧急报警间隔（秒，Tag0x08）\
  private Integer smokeThreshold; //
  烟雾浓度报警阈值（%，Tag0x14）\
  private Integer tempUpperLimit; // 温度报警上限（℃，Tag0x0B）\
  private Integer tempLowerLimit; // 温度报警下限（℃，Tag0x21）\
  // Getter/Setter\
  }

  --------------------------------------------------------------

**2.2.3 前端交互设计**

扩展设备列表组件，支持按IMEI/区域筛选，状态颜色标识（正常/报警/离线）

新增批量操作弹窗，支持选中传感器批量更新联系人与所属区域

传感器详情页分标签展示：基础信息、实时状态、历史数据、参数配置

**2.3 报警处理模块（扩展）**

**2.3.1 报警类型定义**

基于协议报警Tag实现多类型报警区分：

  --------------- --------------- --------------- ----------------------------------------------
  报警类型        协议Tag         Value值         触发条件

  火灾报警        0x01            0x01            烟雾浓度超过阈值（Tag0x14参数）

  温度报警        0x02            0x02            温度超过上限（Tag0x0B）或低于下限（Tag0x21）

  低电报警        0x02            0x02            电池电量低于阈值（设备上报状态）

  防拆报警        0x02            0x03            设备底座分离（设备上报状态）
  --------------- --------------- --------------- ----------------------------------------------

**2.3.2 功能设计**

接收传感器状态消息（指令码0x01），解析报警Tag字段

报警触发时，前端弹窗标红对应传感器，关联显示安装位置与报警类型

按协议优先级处理多报警场景（仅上报优先级最高的报警类型）

支持通过控制指令（指令码0x04）下发蜂鸣器消音命令（Tag0x20）

**2.3.3 实现逻辑**

  --------------------------------------------------------------
  Java\
  \@Service\
  public class SensorAlarmService {\
  // 处理Cat1传感器报警\
  public void handleAlarm(SensorData data) {\
  // 1. 解析报警Tag（0x01/0x02）与Value值\
  AlarmType alarmType = parseAlarmType(data.getTlvData());\
  if (alarmType == null) return;\
  \
  // 2. 记录报警日志（关联IMEI、报警类型、触发值）\
  logAlarmEvent(data.getSensorId(), alarmType,
  data.getTriggerValue());\
  \
  // 3. WebSocket推送报警信息，前端标红设备\
  pushAlarmToWeb(data.getSensorId(), alarmType,
  data.getInstallationLocation());\
  \
  // 4. 调用通知模块，向绑定联系人发送通知\
  notificationService.triggerNotification(data.getSensorId(),
  alarmType);\
  }\
  \
  // 解析报警类型（按协议优先级）\
  private AlarmType parseAlarmType(Map\<Integer, Object\>
  tlvData) {\
  // 优先处理火灾报警（Tag0x01），再处理其他报警（Tag0x02）\
  }\
  }

  --------------------------------------------------------------

**2.4 通知管理模块（新增）**

**2.4.1 功能架构**

**联系人管理**：支持为每个传感器绑定多个联系人，区分通知优先级

**额度管理**：按传感器独立统计免费额度（语音10条/短信20条），超额后计费

**通知触发**：基于报警类型触发，仅向绑定联系人发送对应通知

**充值管理**：支持按传感器单独充值，语音0.25元/条、短信0.1元/条

**2.4.2 核心数据模型**

  --------------------------------------------------------------
  Java\
  // 通知额度实体\
  public class NotificationQuota {\
  private Long id;\
  private String sensorId; // 传感器IMEI号\
  private Integer freeVoiceCount; // 剩余免费语音条数\
  private Integer freeSmsCount; // 剩余免费短信条数\
  private BigDecimal balance; // 账户余额（元）\
  // 计费标准常量\
  public static final BigDecimal VOICE_PRICE = new
  BigDecimal(\"0.25\"); // 语音单价\
  public static final BigDecimal SMS_PRICE = new
  BigDecimal(\"0.1\"); // 短信单价\
  // Getter/Setter\
  }

  --------------------------------------------------------------

**2.4.3 通知触发流程**

接收报警事件，获取传感器IMEI与报警类型

查询该传感器绑定的联系人列表

检查通知额度，优先使用免费额度

调用第三方语音/短信接口发送通知（含报警类型、安装位置信息）

更新额度统计，超额部分从余额扣除

**2.5 数据日志模块（扩展）**

**2.5.1 日志分类扩展**

按传感器维度记录三类核心日志：

**报警日志**：记录IMEI、报警类型、触发值（烟雾浓度/温度）、报警时间、处理状态

**通知日志**：记录通知类型、接收人、发送结果、消耗额度、发送时间

**状态变更日志**：记录在线/离线状态、电池电量变化、参数修改、通信状态（RSRP/SNR）

**2.5.2 查询功能设计**

支持按传感器IMEI、时间范围、日志类型筛选查询

支持导出选中传感器的历史日志（Excel格式）

状态日志关联展示关键参数：烟雾浓度、温度、电池电量、信号质量

**三、接口设计**

**3.1 传感器接入接口**

  --------------------------------------------------------------
  Plain Text\
  \# 传感器数据上报（Cat1协议帧）\
  POST /api/sensor/cat1/report\
  Request: {\
  \"frameData\":
  \"7E0164A7B320000100150200650808691490409805627E\" //
  完整Cat1帧（16进制字符串）\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"上报成功\",\
  \"frameNo\": \"0002\" // 平台应答帧号\
  }

  --------------------------------------------------------------

**3.2 设备管理接口**

  --------------------------------------------------------------
  Plain Text\
  \# 批量更新传感器联系人\
  POST /api/device/sensor/batch/update-contacts\
  Request: {\
  \"sensorIds\": \[\"869149040980562\", \"869149040980563\"\],
  // 传感器IMEI号\
  \"contacts\": \[{\"userId\": 1, \"phone\": \"13800138000\",
  \"notifyType\": 1}\] // notifyType：1-语音 2-短信\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"更新成功\",\
  \"successCount\": 2\
  }\
  \
  \# 查询传感器参数\
  GET /api/device/sensor/params?sensorId=869149040980562\
  Response: {\
  \"code\": 200,\
  \"data\": {\
  \"imei\": \"869149040980562\",\
  \"smokeThreshold\": 100,\
  \"tempUpperLimit\": 50,\
  \"normalWorkInterval\": 86400,\
  \"emergencyAlarmInterval\": 30\
  }\
  }

  --------------------------------------------------------------

**3.3 通知管理接口**

  --------------------------------------------------------------
  Plain Text\
  \# 传感器通知额度查询\
  GET /api/notification/quota?sensorId=869149040980562\
  Response: {\
  \"code\": 200,\
  \"data\": {\
  \"freeVoiceCount\": 5,\
  \"freeSmsCount\": 10,\
  \"balance\": 100.00\
  }\
  }

  --------------------------------------------------------------

**3.4 参数配置接口**

  --------------------------------------------------------------
  Plain Text\
  \# 下发传感器参数配置（对应协议0x07指令）\
  POST /api/sensor/config\
  Request: {\
  \"sensorId\": \"869149040980562\",\
  \"configParams\": {\
  \"smokeThreshold\": 110, // Tag0x14\
  \"tempUpperLimit\": 55, // Tag0x0B\
  \"normalWorkInterval\": 43200 // Tag0x06（12小时）\
  }\
  }\
  Response: {\
  \"code\": 200,\
  \"msg\": \"配置下发成功\",\
  \"confirmStatus\": \"pending\" // 等待终端确认\
  }

  --------------------------------------------------------------

**四、数据存储设计**

**4.1 新增数据表**

**sensor_extend**（传感器扩展信息表）

  -------------------------- ------------------- ---------------------------------
  字段名                     类型                说明

  sensor_id                  VARCHAR(32)         传感器唯一标识（IMEI），主键

  material_code              VARCHAR(64)         物料编码（JTY-GD-TCN2010）

  installation_location      VARCHAR(255)        安装位置

  area_id                    BIGINT              所属区域ID

  area_name                  VARCHAR(64)         所属区域名称

  iccid                      VARCHAR(32)         SIM卡ID（Tag0x70）

  module_version             VARCHAR(64)         通信模组软件版本（Tag0x67）

  normal_work_interval       INT                 正常工作上报间隔（秒，Tag0x06）

  emergency_alarm_interval   INT                 紧急报警间隔（秒，Tag0x08）

  smoke_threshold            INT                 烟雾浓度报警阈值（%，Tag0x14）

  temp_upper_limit           TINYINT             温度报警上限（℃，Tag0x0B）

  temp_lower_limit           TINYINT             温度报警下限（℃，Tag0x21）
  -------------------------- ------------------- ---------------------------------

**sensor_contact**（传感器联系人表）

  ------------------- ------------------- ----------------------
  字段名              类型                说明

  id                  BIGINT              主键

  sensor_id           VARCHAR(32)         传感器IMEI号

  user_id             BIGINT              联系人用户ID

  phone               VARCHAR(20)         联系电话

  notify_type         TINYINT             通知类型（1-语音
                                          2-短信）

  priority            TINYINT             通知优先级（1-最高）
  ------------------- ------------------- ----------------------

**notification_quota**（通知额度表）

  ------------------- ------------------- -------------------
  字段名              类型                说明

  id                  BIGINT              主键

  sensor_id           VARCHAR(32)         传感器IMEI号

  free_voice_count    INT                 剩余免费语音条数

  free_sms_count      INT                 剩余免费短信条数

  balance             DECIMAL(10,2)       账户余额
  ------------------- ------------------- -------------------

**sensor_alarm_log**（传感器报警日志表）

  ------------------- ------------------- -------------------------
  字段名              类型                说明

  id                  BIGINT              主键

  sensor_id           VARCHAR(32)         传感器IMEI号

  alarm_type          TINYINT             报警类型（1-火灾 2-温度
                                          3-低电 4-防拆）

  trigger_value       VARCHAR(32)         触发值（烟雾浓度/温度）

  alarm_time          DATETIME            报警时间

  handle_status       TINYINT             处理状态（0-未处理
                                          1-已处理）

  handle_time         DATETIME            处理时间
  ------------------- ------------------- -------------------------

**4.2 索引设计**

sensor_extend：sensor_id（主键）、area_id（普通索引）

sensor_contact：sensor_id（普通索引）、user_id（普通索引）

notification_quota：sensor_id（主键）

sensor_alarm_log：sensor_id（普通索引）、alarm_time（普通索引）

**五、扩展性设计**

**5.1 传感器类型扩展**

通过物模型动态适配新传感器类型：

在iot_things_model表中新增Cat1传感器类型的属性定义（关联协议Tag）

协议适配层支持新增指令码与TLV解析规则，无需修改核心逻辑

**5.2 设备容量扩展**

基于Netty的NIO模型支持高并发连接，满足100+Cat1传感器同时在线

历史数据采用分表存储，按传感器IMEI哈希分片

Redis集群缓存设备实时状态与通知额度，减轻数据库压力

**5.3 故障隔离机制**

每个传感器的通信会话独立管理，单一设备连接异常不影响其他设备

通知服务采用异步线程池，按传感器IMEI哈希分组，避免单设备通知阻塞

通信层支持重传机制，基于协议帧号处理丢失数据

**六、稳定性保障**

**通信可靠性**

基于Cat1协议的帧校验（CRC）确保数据完整性

设备支持心跳上报与重传机制，超时未响应标记为离线

平台对关键指令（参数配置、控制）要求终端返回确认消息

**数据一致性**

通知额度扣减采用数据库事务，确保计费准确

传感器参数修改记录版本号，支持回滚到历史配置

关键操作（报警、通知、参数修改）记录审计日志

**性能监控**

监控传感器通信状态（RSRP、SNR），异常时触发维护通知

统计帧发送失败计数（Tag0x17），分析通信质量

集成Prometheus监控设备连接数、消息吞吐量，支持自动扩容

**七、总结**

本架构基于现有平台模块化拓展，针对JTY-GD-TCN2010型Cat1传感器的协议规范，完善了传感器接入、设备管理、报警处理等核心模块。方案充分复用现有技术栈，严格遵循硬件应用协议的帧结构、数据格式与交互逻辑，确保设备接入的兼容性与系统稳定性。同时保留扩展能力，支持未来新增传感器类型与功能迭代。
